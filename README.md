## 比赛结果
#### 初赛14/466名，复赛25/68名;

### 比赛比较重要的一些trick
1. Random patch，类似于Random erasing，随机再图片中添加“噪音”，不过该噪音来自训练集；
2. 比赛复赛开始我们就使用比较小的batch-size，32，我们的模型再大的batch-size上效果不好；
3. 过采样提升比较明显；
4. 观察到训练集和常规RGB图片的不同，我们再除方差的时候把GB通道反过来了；
5. Re-ranking做了一些近似，这样内存就装的下了；
6. Centerloss, Tripletloss, Softmax都用上了，center loss weight 和 triplet margin都调过参；
7. 把测试集加到验证集中当作干扰集，这样线上与线下得分一致；
8. 复赛全程用了MGN，该网络效果不错，但是速度很慢，模型也比较大，导致了我们做了很少的实验，也没法训更大的模型；
9. 将测试集通过query聚类去重，然后与gallery关联的方式加入到训练集中去训练，这个方法比较笨，但是也取得了一些效果；  
10. 增大图片输入尺寸会带来一两个点的提升！
11. pretrain太重要了，我们利用了pretrain的trick，分层学习率，FC的学习率比backbone大了10倍。

### 比赛的反思
1. 我们尝试的还是太少了，大部分时间用在了训练MGN上面，MGN计算量真的大，占用的显存比较多，导致我们没法训练更大的模型，我们用到了FP16混合精度训练，但还是浪费了不少时间，看到其他团队还尝试了arcface，我们都没有去尝试，复赛的时候就MGN用到底了；
2. 颜色抖动这个我们用了，过佳大佬也提到了(arcface作者)，但是没用对，看到不少团队都有很大的提升；
3. 测试集的利用太粗暴了。
4. 大部分时间用来调参了，期间也思考了一下数据集的问题，比如GB反方差和过采样以及测试集跨Domain，这些方法都有很大的提升，带来的提升是和调参相当的。

## 下载预训练模型，我们仅仅用了一个预训练模型se-resnet50
http://data.lip6.fr/cadene/pretrainedmodels/se_resnet50-ce0d4300.pth

## 预估训练时间，预测时间
### 1. 训练时间：44小时；
### 2. 预测：2小时；  

| 步骤         | 时间/h    |
|------------|---------|
| 训练中间模型     | 12 小时   |
| 推理测试集特征    | 0.23 小时 |
| 无监督聚类      | 0.14 小时 |
| 训练最终模型     | 32 小时   |
| 最终模型提取特征时间 | 0.2 小时  |
| reranking  | 2小时     |
| total      | 47      |

## DockerFile

详情见`./DockerFile`.
1. 我们训练和推理的容器为同一个容器；
2. 项目在容器中的路径为：`/workspace/code`
3. 我们checkpoint都存放在了`/tmp/data/model`路径下；
4. 最终的模型为`/tmp/data/model/model_final/se_resnet50_model_75.pth`;

## 如何运行
## 一键运行脚本run.sh即可
```bash
bash run.sh
```
